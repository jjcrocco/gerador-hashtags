<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Configurar Setor</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <h1 class="main-title">‚öôÔ∏è Personalizar Meu Gerador</h1>
        <div class="section">
            <label>Nome do Setor</label>
            <input type="text" id="nomeSetor" placeholder="Ex: Atendimento ao Cliente" style="width:100%; padding:12px; margin-bottom:20px; border-radius:8px; border:1px solid #ddd;">
            
            <div id="listaEtapas"></div>

            <button id="addStep" class="nav-button mw" style="background-color: #6c757d;">+ Adicionar Etapa</button>
            <hr style="margin: 20px 0;">
            <button id="btnSalvar" class="btn-copiar" style="width: 100%;">Salvar Configura√ß√£o</button>
            <button onclick="window.location.href='index.html'" style="width:100%; margin-top:10px; background:none; border:none; color:var(--cor-principal); cursor:pointer;">Voltar</button>
        </div>
    </div>

<script type="module">
    import { supabase } from './config.js'

    const lista = document.getElementById('listaEtapas')

    window.addEtapaHtml = () => {
        const div = document.createElement('div')
        div.className = 'etapa-item'
        div.style = "background:#f9f9f9; padding:15px; border-radius:8px; margin-bottom:10px; border:1px solid #eee;"
        div.innerHTML = `
            <input type="text" class="e-label" placeholder="T√≠tulo (Ex: Motivo)" style="width:30%; padding:8px;">
            <input type="text" class="e-tags" placeholder="Hashtags separadas por v√≠rgula" style="width:55%; padding:8px;">
            <button onclick="this.parentElement.remove()" style="color:red; background:none; border:none; cursor:pointer; font-size:1.2em;">üóëÔ∏è</button>`
        lista.appendChild(div)
    }

    document.getElementById('addStep').onclick = window.addEtapaHtml

    document.getElementById('btnSalvar').onclick = async () => {
        const { data: { user } } = await supabase.auth.getUser()
        const nome = document.getElementById('nomeSetor').value
        const itens = document.querySelectorAll('.etapa-item')

        const dados = Array.from(itens).map(it => ({
            label: it.querySelector('.e-label').value,
            opcoes: it.querySelector('.e-tags').value.split(',').map(t => t.trim())
        }))

        const { error } = await supabase.from('categorias_hashtags').upsert({
            user_id: user.id,
            nome_setor: nome,
            dados_etapas: dados
        }, { onConflict: 'user_id' })

        if (error) alert("Erro ao salvar: " + error.message)
        else { alert("Sucesso!"); window.location.href = 'index.html' }
    }
</script>
</body>
</html>